name: Publish Zetanode Image Internal

# Description: Builds the zetanode Docker image using the Makefile and pushes it to Google Artifact Registry.
# This workflow is used for internal testing and development builds.

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch, tag, or commit SHA to build from (optional). If not provided, will use the default branch.'
        required: false
        type: string
      version:
        description: 'Version tag to apply to the image (optional). If not provided, only "latest" tag will be pushed.'
        required: false
        type: string
  pull_request:
    branches:
      - develop

      #trigger

env:
  ARTIFACT_REGISTRY: us-docker.pkg.dev
  GCP_PROJECT: ${{ secrets.GCP_DEV_PROJECT }}
  ARTIFACT_REGISTRY_REPOSITORY: ${{ secrets.DOCKER_REPOSITORY_NAME }}
  IMAGE_NAME: zetanode-snapshot

jobs:
  build-and-push:
    runs-on: gcp-athens-runners
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        shell: bash
        run: |
          gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }} --quiet

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [[ -n "${{ inputs.version }}" ]]; then
            # Use provided version input
            NODE_VERSION="${{ inputs.version }}"
            echo "NODE_VERSION=$NODE_VERSION" >> $GITHUB_ENV
            echo "version=$NODE_VERSION" >> $GITHUB_OUTPUT
            echo "Using provided version: $NODE_VERSION"
          else
            echo "No version provided, will only tag as 'latest'"
            echo "version=" >> $GITHUB_OUTPUT
          fi

      - name: Set commit hash
        id: commit
        run: |
          NODE_COMMIT=$(git log -1 --format='%H')
          echo "NODE_COMMIT=$NODE_COMMIT" >> $GITHUB_ENV
          echo "commit=$NODE_COMMIT" >> $GITHUB_OUTPUT

      - name: Build zetanode image
        run: |
          make zetanode

      - name: Push zetanode image to Artifact Registry
        shell: bash
        run: |
          # Always tag and push as latest
          docker tag zetanode:latest ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT }}/${{ env.ARTIFACT_REGISTRY_REPOSITORY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT }}/${{ env.ARTIFACT_REGISTRY_REPOSITORY }}/${{ env.IMAGE_NAME }}:latest

          # Only tag and push version if provided
          if [[ -n "${{ inputs.version }}" ]]; then
            docker tag zetanode:latest ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT }}/${{ env.ARTIFACT_REGISTRY_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ inputs.version }}
            docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT }}/${{ env.ARTIFACT_REGISTRY_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ inputs.version }}
            echo "Pushed version tag: ${{ inputs.version }}"
          else
            echo "Skipping version tag (only pushed 'latest')"
          fi

      - name: Output image information
        shell: bash
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image**: \`${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          if [[ -n "${{ inputs.version }}" ]]; then
            echo "**Version**: \`${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Version**: \`latest\` (no version tag provided)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Commit**: \`${{ env.NODE_COMMIT }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Image successfully pushed to Google Artifact Registry." >> $GITHUB_STEP_SUMMARY
