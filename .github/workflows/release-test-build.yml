name: Release Test Binaries to Cloudflare R2

# Automates building and uploading test binaries to Cloudflare R2, so developers don't have to
# manually build and upload them from their local machines before testing.

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Custom release version (optional, e.g., v1.0.0-test). If not provided, will auto-generate from branch name, date, and commit hash.'
        required: false
        type: string
      ref:
        description: 'Branch, tag, or commit SHA to build from (optional). If not provided, will use the default branch.'
        required: false
        type: string

jobs:
  prepare-release:
    runs-on: ubuntu-22.04
    outputs:
      release_id: ${{ steps.release_id.outputs.release_id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Generate release identifier
        id: release_id
        env:
          GH_TOKEN: ${{ github.token }}
          CUSTOM_VERSION: ${{ inputs.version }}
          REF_INPUT: ${{ inputs.ref }}
        run: |
          if [ -n "$CUSTOM_VERSION" ]; then
            RELEASE_ID="$CUSTOM_VERSION"
            echo "Using custom version: ${RELEASE_ID}"
          else
            DATE=$(date +%Y%m%d)
            SHORT_HASH=${GITHUB_SHA:0:7}
            # Use ref input if provided, otherwise use default branch
            if [ -n "$REF_INPUT" ]; then
              # Extract branch/tag name from ref (remove refs/heads/ or refs/tags/ prefix)
              BRANCH_NAME=$(echo "$REF_INPUT" | sed 's|^refs/heads/||' | sed 's|^refs/tags/||')
            else
              # Use default branch
              BRANCH_NAME=$(echo "${{ github.ref }}" | sed 's|^refs/heads/||')
            fi
            RELEASE_ID="${BRANCH_NAME}-${DATE}-${SHORT_HASH}"
            echo "Auto-generated release identifier: ${RELEASE_ID}"
            echo "Branch: ${BRANCH_NAME}"
          fi
          echo "release_id=${RELEASE_ID}" >> $GITHUB_OUTPUT
          echo "Release identifier: ${RELEASE_ID}"

      - name: Configure AWS CLI for Cloudflare R2
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        run: |
          aws configure set aws_access_key_id "$R2_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$R2_SECRET_ACCESS_KEY"
          aws configure set default.region auto

      - name: Check if release already exists in R2
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          RELEASE_ID: ${{ steps.release_id.outputs.release_id }}
        run: |
          echo "Checking if ${RELEASE_ID}/ already exists in R2..."
          if aws s3 ls "s3://${R2_BUCKET_NAME}/${RELEASE_ID}/" \
            --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" > /dev/null 2>&1; then
            echo "Error: Release ${RELEASE_ID} already exists in R2"
            exit 1
          fi
          echo "Release ID is unique, proceeding with upload"

  build:
    needs: prepare-release
    runs-on: ${{ vars.RELEASE_RUNNER || 'ubuntu-22.04' }}
    timeout-minutes: 60
    strategy:
      matrix:
        include:
          - target: release-snapshot-zetacore
            component: zetacore
            upload_path: zetacored
          - target: release-snapshot-zetaclient
            component: zetaclient
            upload_path: zetaclientd
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Build ${{ matrix.component }} artifacts
        run: |
          make ${{ matrix.target }}
          if [ ! -d "dist/" ] || [ -z "$(ls -A dist/)" ]; then
            echo "Error: dist/ directory is empty or missing after build"
            exit 1
          else
            echo "Build artifacts present: $(ls -1 dist/ | wc -l) files"
          fi

      - name: Configure AWS CLI for Cloudflare R2
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        run: |
          aws configure set aws_access_key_id "$R2_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$R2_SECRET_ACCESS_KEY"
          aws configure set default.region auto

      - name: Upload ${{ matrix.component }} to Cloudflare R2
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          RELEASE_ID: ${{ needs.prepare-release.outputs.release_id }}
        run: |
          echo "Uploading ${{ matrix.component }} artifacts to R2 bucket: ${R2_BUCKET_NAME}/${RELEASE_ID}/${{ matrix.upload_path }}/"
          aws s3 sync dist/ "s3://${R2_BUCKET_NAME}/${RELEASE_ID}/${{ matrix.upload_path }}/" \
            --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
            --no-progress
          echo "âœ“ ${{ matrix.component }} upload complete"

      - name: Clean up workspace
        if: always()
        run: rm -rf dist/ || echo "Failed to cleanup workspace"

  notify:
    needs: [prepare-release, build]
    runs-on: ubuntu-22.04
    if: always()
    steps:
      - name: Check job status
        id: check_status
        run: |
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS CLI for Cloudflare R2
        if: steps.check_status.outputs.status == 'success'
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        run: |
          aws configure set aws_access_key_id "$R2_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$R2_SECRET_ACCESS_KEY"
          aws configure set default.region auto

      - name: Output summary
        if: steps.check_status.outputs.status == 'success'
        env:
          RELEASE_ID: ${{ needs.prepare-release.outputs.release_id }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
        run: |
          R2_URL="https://dash.cloudflare.com/${R2_ACCOUNT_ID}/r2/default/buckets/${R2_BUCKET_NAME}?prefix=${RELEASE_ID}/"
          echo "## Release Upload Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release ID**: \`${RELEASE_ID}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Path**: \`${RELEASE_ID}/\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${GITHUB_SHA}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All artifacts have been uploaded to Cloudflare R2." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View in Cloudflare R2 Dashboard](${R2_URL})" >> $GITHUB_STEP_SUMMARY

      - name: Notify Slack on Success
        if: steps.check_status.outputs.status == 'success'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_CI_ALERTS }}
          webhook-type: incoming-webhook
          payload: |
            text: "Test binaries uploaded to R2: `${{ needs.prepare-release.outputs.release_id }}`"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Test binaries have been uploaded to Cloudflare R2*\n*Release ID:* `${{ needs.prepare-release.outputs.release_id }}`\n*Path:* `${{ secrets.R2_BUCKET_NAME }}/${{ needs.prepare-release.outputs.release_id }}/`\n*Commit:* `${{ github.sha }}`\n*Repository:* ${{ github.repository }}\n*Triggered by:* ${{ github.actor }}\n\n<https://dash.cloudflare.com/${{ secrets.R2_ACCOUNT_ID }}/r2/default/buckets/${{ secrets.R2_BUCKET_NAME }}?prefix=${{ needs.prepare-release.outputs.release_id }}/|View in Cloudflare R2 Dashboard>"
