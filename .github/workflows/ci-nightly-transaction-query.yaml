name: "NIGHTLY:TRANSACTION:QUERY"

on:
  workflow_dispatch:
    inputs:
      ENVIRONMENT:
        description: 'Network to query (athens or mainnet)'
        required: false
        default: 'athens'
      MAX_BLOCKS:
        description: 'Override the maximum number of blocks to query'
        required: false
        default: ''
      MAX_TRANSACTIONS:
        description: 'Override the maximum number of transactions to process'
        required: false
        default: ''
      CONFIG_OVERRIDE:
        description: 'Override entire config (JSON format, e.g. {"max_blocks":50,"max_transactions":500})'
        required: false
        default: ''
  schedule:
    - cron: "0 7 * * *"

jobs:
  nightly_transaction_query:
    name: "NIGHTLY:TRANSACTION:QUERY"
    runs-on: "ubuntu-latest"
    env:
      ENVIRONMENT: "athens"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: Build zetacored
        run: |
          make install-zetacore
          zetacored version

      - name: Create Custom Config (if provided)
        if: inputs.CONFIG_OVERRIDE != ''
        env:
          CONFIG_OVERRIDE_ENV: ${{ inputs.CONFIG_OVERRIDE }}
        run: |
          mkdir -p tx_query_results
          echo '{ 
            "athens": '"${CONFIG_OVERRIDE_ENV:-"{\"max_blocks\":10,\"max_transactions\":10}"}"',
            "mainnet": '"${CONFIG_OVERRIDE_ENV:-"{\"max_blocks\":10,\"max_transactions\":10}"}"'
          }' > tx_query_results/custom_config.json
          
          echo "Custom configuration:"
          cat tx_query_results/custom_config.json

      - name: Run Transaction Validation
        env:
          ENVIRONMENT: ${{ inputs.ENVIRONMENT || env.ENVIRONMENT }}
          MAX_BLOCKS: ${{ inputs.MAX_BLOCKS }}
          MAX_TRANSACTIONS: ${{ inputs.MAX_TRANSACTIONS }}
          API_KEY: ${{ secrets.ZETACHAIN_API_KEY }}
        run: |
          mkdir -p tx_query_results
          chmod +x .github/actions/transaction-query/validate-transactions.sh
          
          CONFIG_PATH=".github/actions/transaction-query/config/default.json"
          if [[ -f "tx_query_results/custom_config.json" ]]; then
            CONFIG_PATH="tx_query_results/custom_config.json"
          fi
          
          ARGS=""
          if [[ -n "$MAX_BLOCKS" ]]; then
            ARGS="$ARGS --max-blocks \"$MAX_BLOCKS\""
          fi
          
          if [[ -n "$MAX_TRANSACTIONS" ]]; then
            ARGS="$ARGS --max-txs \"$MAX_TRANSACTIONS\""
          fi
          
          .github/actions/transaction-query/validate-transactions.sh \
            --environment "$ENVIRONMENT" \
            --config "$CONFIG_PATH" \
            --api-key "$API_KEY" \
            --output-dir "./tx_query_results" \
            $ARGS
          
          FAILED_COUNT=$(jq 'length' tx_query_results/failed_transactions.json)
          if [[ "$FAILED_COUNT" -gt 0 ]]; then
            echo "::warning::Found $FAILED_COUNT failed transaction queries!"
            echo "First 5 failed transactions:"
            jq 'limit(5; .[])' tx_query_results/failed_transactions.json
          else
            echo "All transactions were successfully queried!"
          fi
          
          cat tx_query_results/summary.md

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: transaction-query-results
          path: tx_query_results
          retention-days: 7

      - name: Alert on Failed Transactions
        if: ${{ success() }}
        env:
          EVENT_NAME: ${{ github.event_name }}
        run: |
          FAILED_COUNT=$(jq 'length' tx_query_results/failed_transactions.json)
          if [[ "$FAILED_COUNT" -gt 0 ]]; then
            echo "::warning::$FAILED_COUNT transactions failed to be queried. This indicates a potential bug in the transaction indexing or retrieval system."
            
            if [[ "$EVENT_NAME" == "schedule" ]]; then
              echo "Exiting with error to trigger notifications since this is a scheduled run"
              exit 1
            fi
          fi

      - name: Notify on Failure
        if: failure() && github.event_name == 'schedule'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
          job_name: "NIGHTLY:TRANSACTION:QUERY"
          text: "Transaction query validation failed! Some transactions could not be queried."
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_CI_ALERTS }}
