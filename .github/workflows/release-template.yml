name: Release Template (Reusable)

on:
  workflow_call:
    inputs:
      version:
        description: 'Version for Release'
        required: true
        type: string
      skip_checks:
        type: boolean
        required: false
        default: false
      skip_release:
        type: boolean
        required: false
        default: false
      component:
        description: 'Component to release (zetacore or zetaclient)'
        required: true
        type: string
      branch_prefix:
        description: 'Expected branch prefix (e.g., release/zetacore/)'
        required: true
        type: string
      make_snapshot_target:
        description: 'Make target for snapshot (e.g., release-snapshot-zetacore)'
        required: true
        type: string
      make_release_target:
        description: 'Make target for release (e.g., release-zetacore)'
        required: true
        type: string
      attestation_paths:
        description: 'Paths for attestation (multiline string)'
        required: true
        type: string
      include_typescript:
        description: 'Whether to publish TypeScript after release'
        type: boolean
        default: false

jobs:
  log:
    runs-on: ubuntu-22.04
    steps:
      - name: "Log inputs"
        env:
          INPUTS: ${{ toJson(inputs) }}
        run: echo "${INPUTS}" | jq -r

  check-branch:
    if: startsWith(github.ref, format('refs/heads/{0}', inputs.branch_prefix))
    runs-on: ubuntu-22.04
    steps:
      - name: Branch
        run: echo "${{ github.ref }}"

  check-goreleaser:
    runs-on: ${{ vars.RELEASE_RUNNER }}
    steps:
      - uses: actions/checkout@v4
      - name: Build release snapshot
        if: inputs.skip_checks != true
        env:
          MAKE_SNAPSHOT_TARGET: ${{ inputs.make_snapshot_target }}
        run: make "$MAKE_SNAPSHOT_TARGET"

  publish-release:
    permissions:
      id-token: write
      contents: write
      attestations: write
    if: inputs.skip_release != true
    needs:
      - check-branch
      - check-goreleaser
    runs-on: ${{ vars.RELEASE_RUNNER }}
    timeout-minutes: 60
    environment: release
    steps:
      - uses: actions/checkout@v4

      - name: Change Log Release Notes
        id: release_notes
        run: |
          awk '/^## /{flag++} flag==1{print}' changelog.md > changelog-current.md
          cat changelog-current.md

      - name: Set Version
        env:
          VERSION_INPUT: ${{ inputs.version }}
        run: echo "GITHUB_TAG_VERSION=${VERSION_INPUT}" >> ${GITHUB_ENV}

      - name: Create Release Tag
        env:
          TAG_VERSION: ${{ env.GITHUB_TAG_VERSION }}
        shell: bash
        run: |
          if git rev-parse "${TAG_VERSION}" >/dev/null 2>&1; then
            echo "Error: Tag ${TAG_VERSION} already exists!"
            echo "If you need to re-release, either:"
            echo "  1. Use a new version number (recommended)"
            echo "  2. Manually delete the tag first with: git push --delete origin ${TAG_VERSION}"
            exit 1
          fi
          git tag "${TAG_VERSION}"
          git push --tags

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.2.0
        with:
          prerelease: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body_path: changelog-current.md
          tag_name: ${{ env.GITHUB_TAG_VERSION }}
          generate_release_notes: false

      - name: Publish Release Files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_CURRENT_TAG: ${{ env.GITHUB_TAG_VERSION }}
          MAKE_RELEASE_TARGET: ${{ inputs.make_release_target }}
        run: |
          touch .release-env
          make "$MAKE_RELEASE_TARGET"

      - name: Artifact Attestations
        id: attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ${{ inputs.attestation_paths }}

      - name: Upload Attestation Bundle
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_VERSION: ${{ env.GITHUB_TAG_VERSION }}
        shell: bash
        run: gh release upload "${TAG_VERSION}" "${{ steps.attestation.outputs.bundle-path }}"

      - name: Clean Up Workspace
        if: always()
        shell: bash
        run: sudo rm -rf * || echo "failed to cleanup workspace please investigate"

  publish-typescript:
    if: inputs.include_typescript
    needs: publish-release
    uses: ./.github/workflows/publish-typescript.yml
    secrets: inherit