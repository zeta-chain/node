package sui

import (
	"encoding/hex"
	"github.com/stretchr/testify/require"
	"testing"
)

func TestParseWithdrawAndCallPayload(t *testing.T) {
	t.Run("can parse a correctly formatted payload", func(t *testing.T) {
		// ARRANGE
		// Payload sample extracted from https://github.com/zeta-chain/example-contracts/pull/250
		//export TOKEN_TYPE="0xb112f370bc8e3ba6e45ad1a954660099fc3e6de2a203df9d26e11aa0d870f635::token::TOKEN"
		//export CONFIG="0x57dd7b5841300199ac87b420ddeb48229523e76af423b4fce37da0cb78604408"
		//export POOL="0xbab1a2d90ea585eab574932e1b3467ff1d5d3f2aee55fed304f963ca2b9209eb"
		//export PARTNER="0xee6f1f44d24a8bf7268d82425d6e7bd8b9c48d11b2119b20756ee150c8e24ac3"
		//export CLOCK="0x039ce62b538a0d0fca21c3c3a5b99adf519d55e534c536568fbcca40ee61fb7e"
		//export MESSAGE="0x3573924024f4a7ff8e6755cb2d9fdeef69bdb65329f081d21b0b6ab37a265d06"
		//npx ts-node sui/setup/encodeCallArgs.ts \
		//"$TOKEN_TYPE" \
		//"$CONFIG,$POOL,$PARTNER,$CLOCK" \
		//"$MESSAGE"
		payload, err := hex.DecodeString("00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000503078623131326633373062633865336261366534356164316139353436363030393966633365366465326132303364663964323665313161613064383730663633353a3a746f6b656e3a3a544f4b454e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000457dd7b5841300199ac87b420ddeb48229523e76af423b4fce37da0cb78604408bab1a2d90ea585eab574932e1b3467ff1d5d3f2aee55fed304f963ca2b9209ebee6f1f44d24a8bf7268d82425d6e7bd8b9c48d11b2119b20756ee150c8e24ac3039ce62b538a0d0fca21c3c3a5b99adf519d55e534c536568fbcca40ee61fb7e00000000000000000000000000000000000000000000000000000000000000203573924024f4a7ff8e6755cb2d9fdeef69bdb65329f081d21b0b6ab37a265d06")
		require.NoError(t, err)

		// ACT
		argumentTypes, objects, message, err := parseWithdrawAndCallPayload(payload)

		// ASSERT
		require.NoError(t, err)
		require.EqualValues(t, []string{
			"0xb112f370bc8e3ba6e45ad1a954660099fc3e6de2a203df9d26e11aa0d870f635::token::TOKEN",
		}, argumentTypes)
		require.EqualValues(t, []string{
			"0x57dd7b5841300199ac87b420ddeb48229523e76af423b4fce37da0cb78604408",
			"0xbab1a2d90ea585eab574932e1b3467ff1d5d3f2aee55fed304f963ca2b9209eb",
			"0xee6f1f44d24a8bf7268d82425d6e7bd8b9c48d11b2119b20756ee150c8e24ac3",
			"0x039ce62b538a0d0fca21c3c3a5b99adf519d55e534c536568fbcca40ee61fb7e",
		}, objects)
		expectedMessage, err := hex.DecodeString("3573924024f4a7ff8e6755cb2d9fdeef69bdb65329f081d21b0b6ab37a265d06")
		require.NoError(t, err)
		require.EqualValues(t, expectedMessage, message)
	})

	t.Run("invalid payload", func(t *testing.T) {
		_, err := hex.DecodeString("invalid")
		require.Error(t, err)
	})
}
